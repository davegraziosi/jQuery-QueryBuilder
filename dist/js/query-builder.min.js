/*!
 * jQuery QueryBuilder 2.5.2-19
 * Copyright 2014-2020 Damien "Mistic" Sorel (http://www.strangeplanet.fr)
 * Licensed under MIT (https://opensource.org/licenses/MIT)
 */
!function(a,b){"function"==typeof define&&define.amd?define(["jquery","dot/doT","jquery-extendext",window],b):"object"==typeof module&&module.exports?a.document?module.exports=b(require("jquery"),require("dot/doT"),require("jquery-extendext")):module.exports=function(a,c){if(!a)throw new Error("jQuery QueryBuilder requires a jQuery Instance");return b(a,require("dot/doT"),void 0,c)}:b(a.jQuery,a.doT,void 0,window)}(this,function(a,b,c,d){"use strict";function e(){this.root=null,this.$=a(this)}function f(a,b,c){var d,e,f=h.selectors;d=b.closest(f.rule_container),d.length&&(e="moveAfter"),e||(d=b.closest(f.group_header),d.length&&(d=b.closest(f.group_container),e="moveAtBegin")),e||(d=b.closest(f.group_container),d.length&&(e="moveAtEnd")),e&&(a[e](c.getModel(d)),c&&a instanceof l&&c.setRuleInputValue(a,a.value))}function g(a){var b=a.match(/(question_mark|numbered|named)(?:\((.)\))?/);return b||(b=[null,"question_mark",void 0]),b}var h=function(c,d){c[0].queryBuilder=this,this.$el=c,this.settings=a.extendext(!0,"replace",{},h.DEFAULTS,d),this.model=new e,this.status={id:null,generated_id:!1,group_id:0,rule_id:0,has_optgroup:!1,has_operator_optgroup:!1},this.filters=this.settings.filters,this.icons=this.settings.icons,this.operators=this.settings.operators,this.templates=this.settings.templates,this.plugins=this.settings.plugins,this.lang=null,void 0===h.regional.en&&i.error("Config",'"i18n/en.js" not loaded.'),this.lang=a.extendext(!0,"replace",{},h.regional.en,h.regional[this.settings.lang_code],this.settings.lang),this.settings.allow_groups===!1?this.settings.allow_groups=0:this.settings.allow_groups===!0&&(this.settings.allow_groups=-1),Object.keys(this.templates).forEach(function(a){this.templates[a]||(this.templates[a]=h.templates[a]),"string"==typeof this.templates[a]&&(this.templates[a]=b.template(this.templates[a]))},this),this.$el.attr("id")||(this.$el.attr("id","qb_"+Math.floor(99999*Math.random())),this.status.generated_id=!0),this.status.id=this.$el.attr("id"),this.$el.addClass("query-builder form-inline"),this.filters=this.checkFilters(this.filters),this.operators=this.checkOperators(this.operators),this.bindEvents(),this.initPlugins()};a.extend(h.prototype,{trigger:function(b){var c=new a.Event(this._tojQueryEvent(b),{builder:this});return this.$el.triggerHandler(c,Array.prototype.slice.call(arguments,1)),c},change:function(b,c){var d=new a.Event(this._tojQueryEvent(b,!0),{builder:this,value:c});return this.$el.triggerHandler(d,Array.prototype.slice.call(arguments,2)),d.value},on:function(a,b){return this.$el.on(this._tojQueryEvent(a),b),this},off:function(a,b){return this.$el.off(this._tojQueryEvent(a),b),this},once:function(a,b){return this.$el.one(this._tojQueryEvent(a),b),this},_tojQueryEvent:function(a,b){return a.split(" ").map(function(a){return a+".queryBuilder"+(b?".filter":"")}).join(" ")}}),h.types={string:"string",integer:"number","double":"number",date:"datetime",time:"datetime",datetime:"datetime","boolean":"boolean"},h.inputs=["text","number","textarea","radio","checkbox","select"],h.modifiable_options=["display_errors","allow_groups","allow_empty","default_condition","default_filter"],h.selectors={group_container:".rules-group-container",rule_container:".rule-container",filter_container:".rule-filter-container",operator_container:".rule-operator-container",value_container:".rule-value-container",error_container:".error-container",condition_container:".rules-group-header .group-conditions",rule_header:".rule-header",group_header:".rules-group-header",group_actions:".group-actions",rule_actions:".rule-actions",rules_list:".rules-group-body>.rules-list",group_condition:".rules-group-header [name$=_cond]",rule_filter:".rule-filter-container [name$=_filter]",rule_operator:".rule-operator-container [name$=_operator]",rule_value:".rule-value-container [name*=_value_]",add_rule:"[data-add=rule]",delete_rule:"[data-delete=rule]",add_group:"[data-add=group]",delete_group:"[data-delete=group]"},h.templates={},h.regional={},h.OPERATORS={equal:{type:"equal",nb_inputs:1,multiple:!1,apply_to:["string","number","datetime","boolean"]},not_equal:{type:"not_equal",nb_inputs:1,multiple:!1,apply_to:["string","number","datetime","boolean"]},"in":{type:"in",nb_inputs:1,multiple:!0,apply_to:["string","number","datetime"]},not_in:{type:"not_in",nb_inputs:1,multiple:!0,apply_to:["string","number","datetime"]},less:{type:"less",nb_inputs:1,multiple:!1,apply_to:["number","datetime"]},less_or_equal:{type:"less_or_equal",nb_inputs:1,multiple:!1,apply_to:["number","datetime"]},greater:{type:"greater",nb_inputs:1,multiple:!1,apply_to:["number","datetime"]},greater_or_equal:{type:"greater_or_equal",nb_inputs:1,multiple:!1,apply_to:["number","datetime"]},between:{type:"between",nb_inputs:2,multiple:!1,apply_to:["number","datetime"]},not_between:{type:"not_between",nb_inputs:2,multiple:!1,apply_to:["number","datetime"]},begins_with:{type:"begins_with",nb_inputs:1,multiple:!1,apply_to:["string"]},not_begins_with:{type:"not_begins_with",nb_inputs:1,multiple:!1,apply_to:["string"]},contains:{type:"contains",nb_inputs:1,multiple:!1,apply_to:["string"]},not_contains:{type:"not_contains",nb_inputs:1,multiple:!1,apply_to:["string"]},ends_with:{type:"ends_with",nb_inputs:1,multiple:!1,apply_to:["string"]},not_ends_with:{type:"not_ends_with",nb_inputs:1,multiple:!1,apply_to:["string"]},is_empty:{type:"is_empty",nb_inputs:0,multiple:!1,apply_to:["string"]},is_not_empty:{type:"is_not_empty",nb_inputs:0,multiple:!1,apply_to:["string"]},is_null:{type:"is_null",nb_inputs:0,multiple:!1,apply_to:["string","number","datetime","boolean"]},is_not_null:{type:"is_not_null",nb_inputs:0,multiple:!1,apply_to:["string","number","datetime","boolean"]}},h.DEFAULTS={filters:[],plugins:[],sort_filters:!1,display_errors:!0,allow_groups:-1,allow_empty:!1,conditions:["AND","OR"],default_condition:"AND",inputs_separator:" , ",select_placeholder:"------",display_empty_filter:!0,default_filter:null,optgroups:{},default_rule_flags:{filter_readonly:!1,operator_readonly:!1,value_readonly:!1,no_delete:!1},default_group_flags:{condition_readonly:!1,no_add_rule:!1,no_add_group:!1,no_delete:!1},templates:{group:null,rule:null,filterSelect:null,operatorSelect:null,ruleValueSelect:null},lang_code:"en",lang:{},operators:["equal","not_equal","in","not_in","less","less_or_equal","greater","greater_or_equal","between","not_between","begins_with","not_begins_with","contains","not_contains","ends_with","not_ends_with","is_empty","is_not_empty","is_null","is_not_null"],icons:{add_group:"glyphicon glyphicon-plus-sign",add_rule:"glyphicon glyphicon-plus",remove_group:"glyphicon glyphicon-remove",remove_rule:"glyphicon glyphicon-remove",error:"glyphicon glyphicon-warning-sign"}},h.plugins={},h.defaults=function(b){return"object"!=typeof b?"string"==typeof b?"object"==typeof h.DEFAULTS[b]?a.extend(!0,{},h.DEFAULTS[b]):h.DEFAULTS[b]:a.extend(!0,{},h.DEFAULTS):void a.extendext(!0,"replace",h.DEFAULTS,b)},h.define=function(a,b,c){h.plugins[a]={fct:b,def:c||{}}},h.extend=function(b){a.extend(h.prototype,b)},h.prototype.initPlugins=function(){if(this.plugins){if(a.isArray(this.plugins)){var b={};this.plugins.forEach(function(a){b[a]=null}),this.plugins=b}Object.keys(this.plugins).forEach(function(b){b in h.plugins?(this.plugins[b]=a.extend(!0,{},h.plugins[b].def,this.plugins[b]||{}),h.plugins[b].fct.call(this,this.plugins[b])):i.error("Config",'Unable to find plugin "{0}"',b)},this)}},h.prototype.getPluginOptions=function(a,b){var c;return this.plugins&&this.plugins[a]?c=this.plugins[a]:h.plugins[a]&&(c=h.plugins[a].def),c?b?c[b]:c:void i.error("Config",'Unable to find plugin "{0}"',a)},h.prototype.init=function(a){this.trigger("afterInit"),a?(this.setRules(a),delete this.settings.rules):this.setRoot(!0)},h.prototype.checkFilters=function(a){var b=[];if(a&&0!==a.length||i.error("Config","Missing filters list"),a.forEach(function(a,c){switch(a.id||i.error("Config","Missing filter {0} id",c),b.indexOf(a.id)!=-1&&i.error("Config",'Filter "{0}" already defined',a.id),b.push(a.id),a.type?h.types[a.type]||i.error("Config",'Invalid type "{0}"',a.type):a.type="string",a.input?"function"!=typeof a.input&&h.inputs.indexOf(a.input)==-1&&i.error("Config",'Invalid input "{0}"',a.input):a.input="number"===h.types[a.type]?"number":"text",a.operators&&a.operators.forEach(function(a){"string"!=typeof a&&i.error("Config","Filter operators must be global operators types (string)")}),a.field||(a.field=a.id),a.label||(a.label=a.field),a.optgroup?(this.status.has_optgroup=!0,this.settings.optgroups[a.optgroup]||(this.settings.optgroups[a.optgroup]=a.optgroup)):a.optgroup=null,a.input){case"radio":case"checkbox":(!a.values||a.values.length<1)&&i.error("Config",'Missing filter "{0}" values',a.id);break;case"select":var d=[];a.has_optgroup=!1,i.iterateOptions(a.values,function(b,c,e){d.push({value:b,label:c,optgroup:e||null}),e&&(a.has_optgroup=!0,this.settings.optgroups[e]||(this.settings.optgroups[e]=e))}.bind(this)),a.has_optgroup?a.values=i.groupSort(d,"optgroup"):a.values=d,a.placeholder&&(void 0===a.placeholder_value&&(a.placeholder_value=-1),a.values.forEach(function(b){b.value==a.placeholder_value&&i.error("Config",'Placeholder of filter "{0}" overlaps with one of its values',a.id)}))}},this),this.settings.sort_filters)if("function"==typeof this.settings.sort_filters)a.sort(this.settings.sort_filters);else{var c=this;a.sort(function(a,b){return c.translate(a.label).localeCompare(c.translate(b.label))})}return this.status.has_optgroup&&(a=i.groupSort(a,"optgroup")),a},h.prototype.checkOperators=function(b){var c=[];return b.forEach(function(d,e){"string"==typeof d?(h.OPERATORS[d]||i.error("Config",'Unknown operator "{0}"',d),b[e]=d=a.extendext(!0,"replace",{},h.OPERATORS[d])):(d.type||i.error("Config",'Missing "type" for operator {0}',e),h.OPERATORS[d.type]&&(b[e]=d=a.extendext(!0,"replace",{},h.OPERATORS[d.type],d)),void 0!==d.nb_inputs&&void 0!==d.apply_to||i.error("Config",'Missing "nb_inputs" and/or "apply_to" for operator "{0}"',d.type)),c.indexOf(d.type)!=-1&&i.error("Config",'Operator "{0}" already defined',d.type),c.push(d.type),d.optgroup?(this.status.has_operator_optgroup=!0,this.settings.optgroups[d.optgroup]||(this.settings.optgroups[d.optgroup]=d.optgroup)):d.optgroup=null},this),this.status.has_operator_optgroup&&(b=i.groupSort(b,"optgroup")),b},h.prototype.bindEvents=function(){var b=this,c=h.selectors;this.$el.on("change.queryBuilder",c.group_condition,function(){if(a(this).is(":checked")){var d=a(this).closest(c.group_container);b.getModel(d).condition=a(this).val()}}),this.$el.on("change.queryBuilder",c.rule_filter,function(){var d=a(this).closest(c.rule_container);b.getModel(d).filter=b.getFilterById(a(this).val())}),this.$el.on("change.queryBuilder",c.rule_operator,function(){var d=a(this).closest(c.rule_container);b.getModel(d).operator=b.getOperatorByType(a(this).val())}),this.$el.on("click.queryBuilder",c.add_rule,function(){var d=a(this).closest(c.group_container);b.addRule(b.getModel(d))}),this.$el.on("click.queryBuilder",c.delete_rule,function(){var d=a(this).closest(c.rule_container);b.deleteRule(b.getModel(d))}),0!==this.settings.allow_groups&&(this.$el.on("click.queryBuilder",c.add_group,function(){var d=a(this).closest(c.group_container);b.addGroup(b.getModel(d))}),this.$el.on("click.queryBuilder",c.delete_group,function(){var d=a(this).closest(c.group_container);b.deleteGroup(b.getModel(d))})),this.model.on({drop:function(a,c){c.$el.remove(),b.refreshGroupsConditions()},add:function(a,c,d,e){0===e?d.$el.prependTo(c.$el.find(">"+h.selectors.rules_list)):d.$el.insertAfter(c.rules[e-1].$el),b.refreshGroupsConditions()},move:function(a,c,d,e){c.$el.detach(),0===e?c.$el.prependTo(d.$el.find(">"+h.selectors.rules_list)):c.$el.insertAfter(d.rules[e-1].$el),b.refreshGroupsConditions()},update:function(a,c,d,e,f){if(c instanceof l)switch(d){case"error":b.updateError(c);break;case"flags":b.applyRuleFlags(c);break;case"filter":b.updateRuleFilter(c,f);break;case"operator":b.updateRuleOperator(c,f);break;case"value":b.updateRuleValue(c,f)}else switch(d){case"error":b.updateError(c);break;case"flags":b.applyGroupFlags(c);break;case"condition":b.updateGroupCondition(c,f)}}})},h.prototype.setRoot=function(b,c,d){b=void 0===b||b===!0;var e=this.nextGroupId(),f=a(this.getGroupTemplate(e,1));return this.$el.append(f),this.model.root=new k(null,f),this.model.root.model=this.model,this.model.root.data=c,this.model.root.flags=a.extend({},this.settings.default_group_flags,d),this.model.root.condition=this.settings.default_condition,this.trigger("afterAddGroup",this.model.root),b&&this.addRule(this.model.root),this.model.root},h.prototype.addGroup=function(b,c,d,e){c=void 0===c||c===!0;var f=b.level+1,g=this.trigger("beforeAddGroup",b,c,f);if(g.isDefaultPrevented())return null;var h=this.nextGroupId(),i=a(this.getGroupTemplate(h,f)),j=b.addGroup(i);return j.data=d,j.flags=a.extend({},this.settings.default_group_flags,e),j.condition=this.settings.default_condition,this.trigger("afterAddGroup",j),this.trigger("rulesChanged"),c&&this.addRule(j),j},h.prototype.deleteGroup=function(a){if(a.isRoot())return!1;var b=this.trigger("beforeDeleteGroup",a);if(b.isDefaultPrevented())return!1;var c=!0;return a.each("reverse",function(a){c&=this.deleteRule(a)},function(a){c&=this.deleteGroup(a)},this),c&&(a.drop(),this.trigger("afterDeleteGroup"),this.trigger("rulesChanged")),c},h.prototype.updateGroupCondition=function(b,c){b.$el.find(">"+h.selectors.group_condition).each(function(){var c=a(this);c.prop("checked",c.val()===b.condition),c.parent().toggleClass("active",c.val()===b.condition)}),this.trigger("afterUpdateGroupCondition",b,c),this.trigger("rulesChanged")},h.prototype.refreshGroupsConditions=function(){!function a(b){(!b.flags||b.flags&&!b.flags.condition_readonly)&&b.$el.find(">"+h.selectors.group_condition).prop("disabled",b.rules.length<=1).parent().toggleClass("disabled",b.rules.length<=1),b.each(null,function(b){a(b)},this)}(this.model.root)},h.prototype.addRule=function(b,c,d){var e=this.trigger("beforeAddRule",b);if(e.isDefaultPrevented())return null;var f=this.nextRuleId(),g=a(this.getRuleTemplate(f)),h=b.addRule(g);return h.data=c,h.flags=a.extend({},this.settings.default_rule_flags,d),this.trigger("afterAddRule",h),this.trigger("rulesChanged"),this.createRuleFilters(h),!this.settings.default_filter&&this.settings.display_empty_filter||(h.filter=this.change("getDefaultFilter",this.getFilterById(this.settings.default_filter||this.filters[0].id),h)),h},h.prototype.deleteRule=function(a){if(a.flags.no_delete)return!1;var b=this.trigger("beforeDeleteRule",a);return!b.isDefaultPrevented()&&(a.drop(),this.trigger("afterDeleteRule"),this.trigger("rulesChanged"),!0)},h.prototype.createRuleFilters=function(b){var c=this.change("getRuleFilters",this.filters,b),d=a(this.getRuleFilterSelect(b,c));b.$el.find(h.selectors.filter_container).html(d),this.trigger("afterCreateRuleFilters",b),this.applyRuleFlags(b)},h.prototype.createRuleOperators=function(b){var c=b.$el.find(h.selectors.operator_container).empty();if(b.filter){var d=this.getOperators(b.filter),e=a(this.getRuleOperatorSelect(b,d));c.html(e),b.filter.default_operator?b.__.operator=this.getOperatorByType(b.filter.default_operator):b.__.operator=d[0],b.$el.find(h.selectors.rule_operator).val(b.operator.type),this.trigger("afterCreateRuleOperators",b,d),this.applyRuleFlags(b)}},h.prototype.createRuleInput=function(b){var c=b.$el.find(h.selectors.value_container).empty();if(b.__.value=void 0,b.filter&&b.operator&&0!==b.operator.nb_inputs){for(var d=this,e=a(),f=b.filter,g=0;g<b.operator.nb_inputs;g++){var i=a(this.getRuleInput(b,g));g>0&&c.append(this.settings.inputs_separator),c.append(i),e=e.add(i)}c.css("display",""),e.on("change "+(f.input_event||""),function(){b._updating_input||(b._updating_value=!0,b.value=d.getRuleInputValue(b),b._updating_value=!1)}),f.plugin&&e[f.plugin](f.plugin_config||{}),this.trigger("afterCreateRuleInput",b),void 0!==f.default_value?b.value=f.default_value:(b._updating_value=!0,b.value=d.getRuleInputValue(b),b._updating_value=!1),this.applyRuleFlags(b)}},h.prototype.updateRuleFilter=function(a,b){this.createRuleOperators(a),this.createRuleInput(a),a.$el.find(h.selectors.rule_filter).val(a.filter?a.filter.id:"-1"),b&&a.filter&&b.id!==a.filter.id&&(a.data=void 0),this.trigger("afterUpdateRuleFilter",a,b),this.trigger("rulesChanged")},h.prototype.updateRuleOperator=function(a,b){var c=a.$el.find(h.selectors.value_container);a.operator&&0!==a.operator.nb_inputs?(c.css("display",""),!c.is(":empty")&&b&&a.operator.nb_inputs===b.nb_inputs&&a.operator.optgroup===b.optgroup||this.createRuleInput(a)):(c.hide(),a.__.value=void 0),a.operator&&(a.$el.find(h.selectors.rule_operator).val(a.operator.type),a.__.value=this.getRuleInputValue(a)),this.trigger("afterUpdateRuleOperator",a,b),this.trigger("rulesChanged")},h.prototype.updateRuleValue=function(a,b){a._updating_value||this.setRuleInputValue(a,a.value),this.trigger("afterUpdateRuleValue",a,b),this.trigger("rulesChanged")},h.prototype.applyRuleFlags=function(a){var b=a.flags,c=h.selectors;a.$el.find(c.rule_filter).prop("disabled",b.filter_readonly),a.$el.find(c.rule_operator).prop("disabled",b.operator_readonly),a.$el.find(c.rule_value).prop("disabled",b.value_readonly),b.no_delete&&a.$el.find(c.delete_rule).remove(),this.trigger("afterApplyRuleFlags",a)},h.prototype.applyGroupFlags=function(a){var b=a.flags,c=h.selectors;a.$el.find(">"+c.group_condition).prop("disabled",b.condition_readonly).parent().toggleClass("readonly",b.condition_readonly),b.no_add_rule&&a.$el.find(c.add_rule).remove(),b.no_add_group&&a.$el.find(c.add_group).remove(),b.no_delete&&a.$el.find(c.delete_group).remove(),this.trigger("afterApplyGroupFlags",a)},h.prototype.clearErrors=function(a){a=a||this.model.root,a&&(a.error=null,a instanceof k&&a.each(function(a){a.error=null},function(a){this.clearErrors(a)},this))},h.prototype.updateError=function(a){if(this.settings.display_errors)if(null===a.error)a.$el.removeClass("has-error");else{var b=this.translate("errors",a.error[0]);b=i.fmt(b,a.error.slice(1)),b=this.change("displayError",b,a.error,a),a.$el.addClass("has-error").find(h.selectors.error_container).eq(0).attr("title",b)}},h.prototype.triggerValidationError=function(b,c,d){a.isArray(c)||(c=[c]);var e=this.trigger("validationError",b,c,d);e.isDefaultPrevented()||(b.error=c)},h.prototype.destroy=function(){this.trigger("beforeDestroy"),this.status.generated_id&&this.$el.removeAttr("id"),this.clear(),this.model=null,this.$el.off(".queryBuilder").removeClass("query-builder").removeData("queryBuilder"),delete this.$el[0].queryBuilder},h.prototype.reset=function(){var b=this.trigger("beforeReset");b.isDefaultPrevented()||(this.status.group_id=1,this.status.rule_id=0,this.model.root.empty(),this.model.root.data=void 0,this.model.root.flags=a.extend({},this.settings.default_group_flags),this.model.root.condition=this.settings.default_condition,this.addRule(this.model.root),this.trigger("afterReset"),this.trigger("rulesChanged"))},h.prototype.clear=function(){var a=this.trigger("beforeClear");a.isDefaultPrevented()||(this.status.group_id=0,this.status.rule_id=0,this.model.root&&(this.model.root.drop(),this.model.root=null),this.trigger("afterClear"),this.trigger("rulesChanged"))},h.prototype.setOptions=function(b){a.each(b,function(a,b){h.modifiable_options.indexOf(a)!==-1&&(this.settings[a]=b)}.bind(this))},h.prototype.getModel=function(b){return b?b instanceof j?b:a(b).data("queryBuilderModel"):this.model.root},h.prototype.validate=function(b){b=a.extend({skip_empty:!1},b),this.clearErrors();var c=this,d=function e(a){var d=0,f=0;return a.each(function(a){if(a.filter||!b.skip_empty){if(!a.filter)return c.triggerValidationError(a,"no_filter",null),void f++;if(!a.operator)return c.triggerValidationError(a,"no_operator",null),void f++;if(0!==a.operator.nb_inputs){var e=c.validateValue(a,a.value);if(e!==!0)return c.triggerValidationError(a,e,a.value),void f++}d++}},function(a){var b=e(a);b===!0?d++:b===!1&&f++}),!(f>0)&&(0===d&&!a.isRoot()&&b.skip_empty?null:!!(0!==d||c.settings.allow_empty&&a.isRoot())||(c.triggerValidationError(a,"empty_group",null),!1))}(this.model.root);return this.change("validate",d)},h.prototype.getRules=function(b){b=a.extend({get_flags:!1,allow_invalid:!1,skip_empty:!1},b);var c=this.validate(b);if(!c&&!b.allow_invalid)return null;var d=this,e=function f(c){var e={condition:c.condition,rules:[]};if(c.data&&(e.data=a.extendext(!0,"replace",{},c.data)),b.get_flags){var g=d.getGroupFlags(c.flags,"all"===b.get_flags);a.isEmptyObject(g)||(e.flags=g)}return c.each(function(c){if(c.filter||!b.skip_empty){var f=null;c.operator&&0===c.operator.nb_inputs||(f=c.value);var g={id:c.filter?c.filter.id:null,field:c.filter?c.filter.field:null,type:c.filter?c.filter.type:null,input:c.filter?c.filter.input:null,operator:c.operator?c.operator.type:null,value:f};if((c.filter&&c.filter.data||c.data)&&(g.data=a.extendext(!0,"replace",{},c.filter.data,c.data)),b.get_flags){var h=d.getRuleFlags(c.flags,"all"===b.get_flags);a.isEmptyObject(h)||(g.flags=h)}e.rules.push(d.change("ruleToJson",g,c))}},function(a){var c=f(a);0===c.rules.length&&b.skip_empty||e.rules.push(c)},this),d.change("groupToJson",e,c)}(this.model.root);return e.valid=c,this.change("getRules",e)},h.prototype.setRules=function(b,c){c=a.extend({allow_invalid:!1},c),a.isArray(b)&&(b={condition:this.settings.default_condition,rules:b}),b&&b.rules&&(0!==b.rules.length||this.settings.allow_empty)||i.error("RulesParse","Incorrect data object passed"),this.clear(),this.setRoot(!1,b.data,this.parseGroupFlags(b)),b=this.change("setRules",b,c);var d=this;!function e(a,b){null!==b&&(void 0===a.condition?a.condition=d.settings.default_condition:d.settings.conditions.indexOf(a.condition)==-1&&(i.error(!c.allow_invalid,"UndefinedCondition",'Invalid condition "{0}"',a.condition),a.condition=d.settings.default_condition),b.condition=a.condition,a.rules.forEach(function(a){var f;if(void 0!==a.rules)if(d.settings.allow_groups!==-1&&d.settings.allow_groups<b.level)i.error(!c.allow_invalid,"RulesParse","No more than {0} groups are allowed",d.settings.allow_groups),d.reset();else{if(f=d.addGroup(b,!1,a.data,d.parseGroupFlags(a)),null===f)return;e(a,f)}else{if(a.empty||(void 0===a.id&&(i.error(!c.allow_invalid,"RulesParse","Missing rule field id"),a.empty=!0),void 0===a.operator&&(a.operator="equal")),f=d.addRule(b,a.data,d.parseRuleFlags(a)),null===f)return;a.empty||(f.filter=d.getFilterById(a.id,!c.allow_invalid)),f.filter&&(f.operator=d.getOperatorByType(a.operator,!c.allow_invalid),f.operator||(f.operator=d.getOperators(f.filter)[0])),f.operator&&0!==f.operator.nb_inputs&&(void 0!==a.value?f.value=a.value:void 0!==f.filter.default_value&&(f.value=f.filter.default_value)),d.change("jsonToRule",f,a)!=f&&i.error("RulesParse","Plugin tried to change rule reference")}}),d.change("jsonToGroup",b,a)!=b&&i.error("RulesParse","Plugin tried to change group reference"))}(b,this.model.root),this.trigger("afterSetRules")},h.prototype.validateValue=function(a,b){var c=a.filter.validation||{},d=!0;return d=c.callback?c.callback.call(this,b,a):this._validateValue(a,b),this.change("validateValue",d,b,a)},h.prototype._validateValue=function(b,c){var e,f,g=b.filter,j=b.operator,k=g.validation||{},l=!0;1!==b.operator.nb_inputs||Array.isArray(c)||(c=[c]);for(var m=0;m<j.nb_inputs;m++){if(!j.multiple&&a.isArray(c[m])&&c[m].length>1){l=["operator_not_multiple",j.type,this.translate("operators",j.type)];break}switch(g.input){case"radio":if(void 0===c[m]||0===c[m].length){k.allow_empty_value||(l=["radio_empty"]);break}break;case"checkbox":if(void 0===c[m]||0===c[m].length){k.allow_empty_value||(l=["checkbox_empty"]);break}break;case"select":if(void 0===c[m]||0===c[m].length||g.placeholder&&c[m]==g.placeholder_value){k.allow_empty_value||(l=["select_empty"]);break}break;default:f=a.isArray(c[m])?c[m]:[c[m]];for(var n=0;n<f.length;n++){switch(h.types[g.type]){case"string":if(void 0===f[n]||0===f[n].length){k.allow_empty_value||(l=["string_empty"]);break}if(void 0!==k.min&&f[n].length<parseInt(k.min)){l=[this.getValidationMessage(k,"min","string_exceed_min_length"),k.min];break}if(void 0!==k.max&&f[n].length>parseInt(k.max)){l=[this.getValidationMessage(k,"max","string_exceed_max_length"),k.max];break}if(k.format&&("string"==typeof k.format&&(k.format=new RegExp(k.format)),!k.format.test(f[n]))){l=[this.getValidationMessage(k,"format","string_invalid_format"),k.format];break}break;case"number":if(void 0===f[n]||0===f[n].length){k.allow_empty_value||(l=["number_nan"]);break}if(isNaN(f[n])){l=["number_nan"];break}if("integer"==g.type){if(parseInt(f[n])!=f[n]){l=["number_not_integer"];break}}else if(parseFloat(f[n])!=f[n]){l=["number_not_double"];break}if(void 0!==k.min&&f[n]<parseFloat(k.min)){l=[this.getValidationMessage(k,"min","number_exceed_min"),k.min];break}if(void 0!==k.max&&f[n]>parseFloat(k.max)){l=[this.getValidationMessage(k,"max","number_exceed_max"),k.max];break}if(void 0!==k.step&&"any"!==k.step){var o=(f[n]/k.step).toPrecision(14);if(parseInt(o)!=o){l=[this.getValidationMessage(k,"step","number_wrong_step"),k.step];break}}break;case"datetime":if(void 0===f[n]||0===f[n].length){k.allow_empty_value||(l=["datetime_empty"]);break}if(k.format){"moment"in d||i.error("MissingLibrary","MomentJS is required for Date/Time validation. Get it here http://momentjs.com");var p=moment(f[n],k.format);if(!p.isValid()){l=[this.getValidationMessage(k,"format","datetime_invalid"),k.format];break}if(k.min&&p<moment(k.min,k.format)){l=[this.getValidationMessage(k,"min","datetime_exceed_min"),k.min];break}if(k.max&&p>moment(k.max,k.format)){l=[this.getValidationMessage(k,"max","datetime_exceed_max"),k.max];break}}break;case"boolean":if(void 0===f[n]||0===f[n].length){k.allow_empty_value||(l=["boolean_not_valid"]);break}if(e=(""+f[n]).trim().toLowerCase(),"true"!==e&&"false"!==e&&"1"!==e&&"0"!==e&&1!==f[n]&&0!==f[n]){l=["boolean_not_valid"];break}}if(l!==!0)break}}if(l!==!0)break}if(("between"===b.operator.type||"not_between"===b.operator.type)&&2===c.length)switch(h.types[g.type]){case"number":c[0]>c[1]&&(l=["number_between_invalid",c[0],c[1]]);break;case"datetime":k.format&&("moment"in d||i.error("MissingLibrary","MomentJS is required for Date/Time validation. Get it here http://momentjs.com"),moment(c[0],k.format).isAfter(moment(c[1],k.format))&&(l=["datetime_between_invalid",c[0],c[1]]))}return l},h.prototype.nextGroupId=function(){return this.status.id+"_group_"+this.status.group_id++},h.prototype.nextRuleId=function(){return this.status.id+"_rule_"+this.status.rule_id++},h.prototype.getOperators=function(a){"string"==typeof a&&(a=this.getFilterById(a));for(var b=[],c=0,d=this.operators.length;c<d;c++){if(a.operators){if(a.operators.indexOf(this.operators[c].type)==-1)continue}else if(this.operators[c].apply_to.indexOf(h.types[a.type])==-1)continue;b.push(this.operators[c])}return a.operators&&b.sort(function(b,c){return a.operators.indexOf(b.type)-a.operators.indexOf(c.type)}),this.change("getOperators",b,a)},h.prototype.getFilterById=function(a,b){if("-1"==a)return null;for(var c=0,d=this.filters.length;c<d;c++)if(this.filters[c].id==a)return this.filters[c];return i.error(b!==!1,"UndefinedFilter",'Undefined filter "{0}"',a),null},h.prototype.getOperatorByType=function(a,b){if("-1"==a)return null;for(var c=0,d=this.operators.length;c<d;c++)if(this.operators[c].type==a)return this.operators[c];return i.error(b!==!1,"UndefinedOperator",'Undefined operator "{0}"',a),null},h.prototype.getRuleInputValue=function(b){var c=b.filter,d=b.operator,e=[];if(c.valueGetter)e=c.valueGetter.call(this,b);else{for(var f=b.$el.find(h.selectors.value_container),g=0;g<d.nb_inputs;g++){var j,k=i.escapeElementId(b.id+"_value_"+g);switch(c.input){case"radio":e.push(f.find("[name="+k+"]:checked").val());break;case"checkbox":j=[],f.find("[name="+k+"]:checked").each(function(){j.push(a(this).val())}),e.push(j);break;case"select":c.multiple?(j=[],f.find("[name="+k+"] option:selected").each(function(){j.push(a(this).val())}),e.push(j)):e.push(f.find("[name="+k+"] option:selected").val());break;default:e.push(f.find("[name="+k+"]").val())}}e=e.map(function(b){return d.multiple&&c.value_separator&&"string"==typeof b&&(b=b.split(c.value_separator)),a.isArray(b)?b.map(function(a){return i.changeType(a,c.type)}):i.changeType(b,c.type)}),1===d.nb_inputs&&(e=e[0]),c.valueParser&&(e=c.valueParser.call(this,b,e))}return this.change("getRuleValue",e,b)},h.prototype.setRuleInputValue=function(b,c){var d=b.filter,e=b.operator;if(d&&e){if(b._updating_input=!0,d.valueSetter)d.valueSetter.call(this,b,c);else{var f=b.$el.find(h.selectors.value_container);1==e.nb_inputs&&(c=[c]);for(var g=0;g<e.nb_inputs;g++){var j=i.escapeElementId(b.id+"_value_"+g);switch(d.input){case"radio":f.find("[name="+j+'][value="'+c[g]+'"]').prop("checked",!0).trigger("change");break;case"checkbox":a.isArray(c[g])||(c[g]=[c[g]]),c[g].forEach(function(a){f.find("[name="+j+'][value="'+a+'"]').prop("checked",!0).trigger("change")});break;default:e.multiple&&d.value_separator&&a.isArray(c[g])&&(c[g]=c[g].join(d.value_separator)),f.find("[name="+j+"]").val(c[g]).trigger("change")}}}b._updating_input=!1}},h.prototype.parseRuleFlags=function(b){var c=a.extend({},this.settings.default_rule_flags);return b.readonly&&a.extend(c,{filter_readonly:!0,operator_readonly:!0,value_readonly:!0,no_delete:!0}),b.flags&&a.extend(c,b.flags),this.change("parseRuleFlags",c,b)},h.prototype.getRuleFlags=function(b,c){if(c)return a.extend({},b);var d={};return a.each(this.settings.default_rule_flags,function(a,c){b[a]!==c&&(d[a]=b[a])}),d},h.prototype.parseGroupFlags=function(b){var c=a.extend({},this.settings.default_group_flags);return b.readonly&&a.extend(c,{condition_readonly:!0,no_add_rule:!0,no_add_group:!0,no_delete:!0}),b.flags&&a.extend(c,b.flags),this.change("parseGroupFlags",c,b)},h.prototype.getGroupFlags=function(b,c){if(c)return a.extend({},b);var d={};return a.each(this.settings.default_group_flags,function(a,c){b[a]!==c&&(d[a]=b[a])}),d},h.prototype.translate=function(a,b){b||(b=a,a=void 0);var c;return c="object"==typeof b?b[this.settings.lang_code]||b.en:(a?this.lang[a]:this.lang)[b]||b,this.change("translate",c,b,a)},h.prototype.getValidationMessage=function(a,b,c){return a.messages&&a.messages[b]||c},h.templates.group='<div id="{{= it.group_id }}" class="rules-group-container">   <div class="rules-group-header">     <div class="btn-group pull-right group-actions">       <button type="button" class="btn btn-xs btn-success" data-add="rule">         <i class="{{= it.icons.add_rule }}" title="{{= it.translate("add_rule_title") }}" ></i> {{= it.translate("add_rule") }}       </button>       {{? it.settings.allow_groups===-1 || it.settings.allow_groups>=it.level }}         <button type="button" class="btn btn-xs btn-success" data-add="group">           <i class="{{= it.icons.add_group }}" title="{{= it.translate("add_group_title") }}"></i> {{= it.translate("add_group") }}         </button>       {{?}}       {{? it.level>1 }}         <button type="button" class="btn btn-xs btn-danger" data-delete="group">           <i class="{{= it.icons.remove_group }}" title="{{= it.translate("delete_group_title") }}" ></i> {{= it.translate("delete_group") }}         </button>       {{?}}     </div>     <div class="btn-group group-conditions">       {{~ it.conditions: condition }}         <label class="btn btn-xs btn-primary">           <input type="radio" name="{{= it.group_id }}_cond" value="{{= condition }}"> {{= it.translate("conditions", condition) }}         </label>       {{~}}     </div>     {{? it.settings.display_errors }}       <div class="error-container"><i class="{{= it.icons.error }}"></i></div>     {{?}}   </div>   <div class=rules-group-body>     <div class=rules-list></div>   </div> </div>',h.templates.rule='<div id="{{= it.rule_id }}" class="rule-container">   <div class="rule-header">     <div class="btn-group pull-right rule-actions">       <button type="button" class="btn btn-xs btn-danger" data-delete="rule">         <i class="{{= it.icons.remove_rule }}" title="{{= it.translate("delete_rule_title") }}" ></i> {{= it.translate("delete_rule") }}       </button>     </div>   </div>   {{? it.settings.display_errors }}     <div class="error-container"><i class="{{= it.icons.error }}"></i></div>   {{?}}   <div class="rule-filter-container"></div>   <div class="rule-operator-container"></div>   <div class="rule-value-container"></div> </div>',
h.templates.filterSelect='{{ var optgroup = null; }} <select class="form-control" name="{{= it.rule.id }}_filter">   {{? it.settings.display_empty_filter }}     <option value="-1">{{= it.settings.select_placeholder }}</option>   {{?}}   {{~ it.filters: filter }}     {{? optgroup !== filter.optgroup }}       {{? optgroup !== null }}</optgroup>{{?}}       {{? (optgroup = filter.optgroup) !== null }}         <optgroup label="{{= it.translate(it.settings.optgroups[optgroup]) }}">       {{?}}     {{?}}     <option value="{{= filter.id }}" {{? filter.icon}}data-icon="{{= filter.icon}}"{{?}}>{{= it.translate(filter.label) }}</option>   {{~}}   {{? optgroup !== null }}</optgroup>{{?}} </select>',h.templates.operatorSelect='{{? it.operators.length === 1 }} <span> {{= it.translate("operators", it.operators[0].type) }} </span> {{?}} {{ var optgroup = null; }} <select class="form-control {{? it.operators.length === 1 }}hide{{?}}" name="{{= it.rule.id }}_operator">   {{~ it.operators: operator }}     {{? optgroup !== operator.optgroup }}       {{? optgroup !== null }}</optgroup>{{?}}       {{? (optgroup = operator.optgroup) !== null }}         <optgroup label="{{= it.translate(it.settings.optgroups[optgroup]) }}">       {{?}}     {{?}}     <option value="{{= operator.type }}" {{? operator.icon}}data-icon="{{= operator.icon}}"{{?}}>{{= it.translate("operators", operator.type) }}</option>   {{~}}   {{? optgroup !== null }}</optgroup>{{?}} </select>',h.templates.ruleValueSelect='{{ var optgroup = null; }} <select class="form-control" name="{{= it.name }}" {{? it.rule.filter.multiple }}multiple{{?}}>   {{? it.rule.filter.placeholder }}     <option value="{{= it.rule.filter.placeholder_value }}" disabled selected>{{= it.rule.filter.placeholder }}</option>   {{?}}   {{~ it.rule.filter.values: entry }}     {{? optgroup !== entry.optgroup }}       {{? optgroup !== null }}</optgroup>{{?}}       {{? (optgroup = entry.optgroup) !== null }}         <optgroup label="{{= it.translate(it.settings.optgroups[optgroup]) }}">       {{?}}     {{?}}     <option value="{{= entry.value }}">{{= entry.label }}</option>   {{~}}   {{? optgroup !== null }}</optgroup>{{?}} </select>',h.prototype.getGroupTemplate=function(a,b){var c=this.templates.group({builder:this,group_id:a,level:b,conditions:this.settings.conditions,icons:this.icons,settings:this.settings,translate:this.translate.bind(this)});return this.change("getGroupTemplate",c,b)},h.prototype.getRuleTemplate=function(a){var b=this.templates.rule({builder:this,rule_id:a,icons:this.icons,settings:this.settings,translate:this.translate.bind(this)});return this.change("getRuleTemplate",b)},h.prototype.getRuleFilterSelect=function(a,b){var c=this.templates.filterSelect({builder:this,rule:a,filters:b,icons:this.icons,settings:this.settings,translate:this.translate.bind(this)});return this.change("getRuleFilterSelect",c,a,b)},h.prototype.getRuleOperatorSelect=function(a,b){var c=this.templates.operatorSelect({builder:this,rule:a,operators:b,icons:this.icons,settings:this.settings,translate:this.translate.bind(this)});return this.change("getRuleOperatorSelect",c,a,b)},h.prototype.getRuleValueSelect=function(a,b){var c=this.templates.ruleValueSelect({builder:this,name:a,rule:b,icons:this.icons,settings:this.settings,translate:this.translate.bind(this)});return this.change("getRuleValueSelect",c,a,b)},h.prototype.getRuleInput=function(a,b){var c=a.filter,d=a.filter.validation||{},e=a.id+"_value_"+b,f=c.vertical?" class=block":"",g="";if("function"==typeof c.input)g=c.input.call(this,a,e);else switch(c.input){case"radio":case"checkbox":i.iterateOptions(c.values,function(a,b){g+="<label"+f+'><input type="'+c.input+'" name="'+e+'" value="'+a+'"> '+b+"</label> "});break;case"select":g=this.getRuleValueSelect(e,a);break;case"textarea":g+='<textarea class="form-control" name="'+e+'"',c.size&&(g+=' cols="'+c.size+'"'),c.rows&&(g+=' rows="'+c.rows+'"'),void 0!==d.min&&(g+=' minlength="'+d.min+'"'),void 0!==d.max&&(g+=' maxlength="'+d.max+'"'),c.placeholder&&(g+=' placeholder="'+c.placeholder+'"'),g+="></textarea>";break;case"number":g+='<input class="form-control" type="number" name="'+e+'"',void 0!==d.step&&(g+=' step="'+d.step+'"'),void 0!==d.min&&(g+=' min="'+d.min+'"'),void 0!==d.max&&(g+=' max="'+d.max+'"'),c.placeholder&&(g+=' placeholder="'+c.placeholder+'"'),c.size&&(g+=' size="'+c.size+'"'),g+=">";break;default:g+='<input class="form-control" type="text" name="'+e+'"',c.placeholder&&(g+=' placeholder="'+c.placeholder+'"'),"string"===c.type&&void 0!==d.min&&(g+=' minlength="'+d.min+'"'),"string"===c.type&&void 0!==d.max&&(g+=' maxlength="'+d.max+'"'),c.size&&(g+=' size="'+c.size+'"'),g+=">"}return this.change("getRuleInput",g,a,e)};var i={};h.utils=i,i.iterateOptions=function(b,c){b&&(a.isArray(b)?b.forEach(function(b){a.isPlainObject(b)?"value"in b?c(b.value,b.label||b.value,b.optgroup):a.each(b,function(a,b){return c(a,b),!1}):c(b,b)}):a.each(b,function(a,b){c(a,b)}))},i.fmt=function(a,b){return Array.isArray(b)||(b=Array.prototype.slice.call(arguments,1)),a.replace(/{([0-9]+)}/g,function(a,c){return b[parseInt(c)]})},i.error=function(){var a=0,b="boolean"!=typeof arguments[a]||arguments[a++],c=arguments[a++],d=arguments[a++],e=Array.isArray(arguments[a])?arguments[a]:Array.prototype.slice.call(arguments,a);if(b){var f=new Error(i.fmt(d,e));throw f.name=c+"Error",f.args=e,f}console.error(c+"Error: "+i.fmt(d,e))},i.changeType=function(a,b){if(""!==a&&void 0!==a)switch(b){case"integer":return"string"!=typeof a||/^-?\d+$/.test(a)?parseInt(a):a;case"double":return"string"!=typeof a||/^-?\d+\.?\d*$/.test(a)?parseFloat(a):a;case"boolean":return"string"!=typeof a||/^(0|1|true|false){1}$/i.test(a)?a===!0||1===a||"true"===a.toLowerCase()||"1"===a:a;default:return a}},i.escapeString=function(a){return"string"!=typeof a?a:a.replace(/[\0\n\r\b\'\"]/g,function(a){switch(a){case"\0":return"\\0";case"\n":return"\\n";case"\r":return"\\r";case"\b":return"\\b";case"'":return"''";default:return"\\"+a}}).replace(/\t/g,"\\t").replace(/\x1a/g,"\\Z")},i.escapeRegExp=function(a){return a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")},i.escapeElementId=function(a){return a?a.replace(/(\\)?([:.\[\],])/g,function(a,b,c){return b?a:"\\"+c}):a},i.groupSort=function(a,b){var c=[],d=[];return a.forEach(function(a){var e;a[b]?(e=c.lastIndexOf(a[b]),e==-1?e=c.length:e++):e=c.length,c.splice(e,0,a[b]),d.splice(e,0,a)}),d},i.defineModelProperties=function(b,c){c.forEach(function(c){Object.defineProperty(b.prototype,c,{enumerable:!0,get:function(){return this.__[c]},set:function(b){var d=null!==this.__[c]&&"object"==typeof this.__[c]?a.extend({},this.__[c]):this.__[c];this.__[c]=b,null!==this.model&&this.model.trigger("update",this,c,b,d)}})})},a.extend(e.prototype,{trigger:function(b){var c=new a.Event(b);return this.$.triggerHandler(c,Array.prototype.slice.call(arguments,1)),c},on:function(){return this.$.on.apply(this.$,Array.prototype.slice.call(arguments)),this},off:function(){return this.$.off.apply(this.$,Array.prototype.slice.call(arguments)),this},once:function(){return this.$.one.apply(this.$,Array.prototype.slice.call(arguments)),this}});var j=function(a,b){return this instanceof j?(Object.defineProperty(this,"__",{value:{}}),b.data("queryBuilderModel",this),this.__.level=1,this.__.error=null,this.__.flags={},this.__.data=void 0,this.$el=b,this.id=b[0].id,this.model=null,void(this.parent=a)):new j(a,b)};i.defineModelProperties(j,["level","error","data","flags"]),Object.defineProperty(j.prototype,"parent",{enumerable:!0,get:function(){return this.__.parent},set:function(a){this.__.parent=a,this.level=null===a?1:a.level+1,this.model=null===a?null:a.model}}),j.prototype.isRoot=function(){return 1===this.level},j.prototype.getPos=function(){return this.isRoot()?-1:this.parent.getNodePos(this)},j.prototype.drop=function(){var a=this.model;this.parent&&this.parent.removeNode(this),this.$el.removeData("queryBuilderModel"),null!==a&&a.trigger("drop",this)},j.prototype.moveAfter=function(a){this.isRoot()||this.move(a.parent,a.getPos()+1)},j.prototype.moveAtBegin=function(a){this.isRoot()||(void 0===a&&(a=this.parent),this.move(a,0))},j.prototype.moveAtEnd=function(a){this.isRoot()||(void 0===a&&(a=this.parent),this.move(a,0===a.length()?0:a.length()-1))},j.prototype.move=function(a,b){this.isRoot()||("number"==typeof a&&(b=a,a=this.parent),this.parent.removeNode(this),a.insertNode(this,b,!1),null!==this.model&&this.model.trigger("move",this,a,b))};var k=function(a,b){return this instanceof k?(j.call(this,a,b),this.rules=[],void(this.__.condition=null)):new k(a,b)};k.prototype=Object.create(j.prototype),k.prototype.constructor=k,i.defineModelProperties(k,["condition"]),k.prototype.empty=function(){this.each("reverse",function(a){a.drop()},function(a){a.drop()})},k.prototype.drop=function(){this.empty(),j.prototype.drop.call(this)},k.prototype.length=function(){return this.rules.length},k.prototype.insertNode=function(a,b,c){return void 0===b&&(b=this.length()),this.rules.splice(b,0,a),a.parent=this,c&&null!==this.model&&this.model.trigger("add",this,a,b),a},k.prototype.addGroup=function(a,b){return this.insertNode(new k(this,a),b,!0)},k.prototype.addRule=function(a,b){return this.insertNode(new l(this,a),b,!0)},k.prototype.removeNode=function(a){var b=this.getNodePos(a);b!==-1&&(a.parent=null,this.rules.splice(b,1))},k.prototype.getNodePos=function(a){return this.rules.indexOf(a)},k.prototype.each=function(a,b,c,d){"boolean"!=typeof a&&"string"!=typeof a&&(d=c,c=b,b=a,a=!1),d=void 0===d?null:d;for(var e=a?this.rules.length-1:0,f=a?0:this.rules.length-1,g=a?-1:1,h=function(){return a?e>=f:e<=f},i=!1;h()&&(this.rules[e]instanceof k?c&&(i=c.call(d,this.rules[e])===!1):b&&(i=b.call(d,this.rules[e])===!1),!i);e+=g);return!i},k.prototype.contains=function(a,b){return this.getNodePos(a)!==-1||!!b&&!this.each(function(){return!0},function(b){return!b.contains(a,!0)})};var l=function(a,b){return this instanceof l?(j.call(this,a,b),this._updating_value=!1,this._updating_input=!1,this.__.filter=null,this.__.operator=null,void(this.__.value=void 0)):new l(a,b)};return l.prototype=Object.create(j.prototype),l.prototype.constructor=l,i.defineModelProperties(l,["filter","operator","value"]),l.prototype.isRoot=function(){return!1},h.Group=k,h.Rule=l,a.fn.queryBuilder=function(a){0===this.length&&i.error("Config","No target defined"),this.length>1&&i.error("Config","Unable to initialize on multiple target");var b=this.data("queryBuilder"),c="object"==typeof a&&a||{};if(!b&&"destroy"==a)return this;if(!b){var d=new h(this,c);this.data("queryBuilder",d),d.init(c.rules)}return"string"==typeof a?b[a].apply(b,Array.prototype.slice.call(arguments,1)):this},a.fn.queryBuilder.constructor=h,a.fn.queryBuilder.defaults=h.defaults,a.fn.queryBuilder.extend=h.extend,a.fn.queryBuilder.define=h.define,a.fn.queryBuilder.regional=h.regional,h.define("bt-checkbox",function(a){"glyphicons"==a.font&&this.$el.addClass("bt-checkbox-glyphicons"),this.on("getRuleInput.filter",function(b,c,d){var e=c.filter;if(("radio"===e.input||"checkbox"===e.input)&&!e.plugin){b.value="",e.colors||(e.colors={}),e.color&&(e.colors._def_=e.color);var f=e.vertical?' style="display:block"':"",g=0;i.iterateOptions(e.values,function(c,h){var i=e.colors[c]||e.colors._def_||a.color,j=d+"_"+g++;b.value+="<div"+f+' class="'+e.input+" "+e.input+"-"+i+'">   <input type="'+e.input+'" name="'+d+'" id="'+j+'" value="'+c+'">   <label for="'+j+'">'+h+"</label> </div>"})}})},{font:"glyphicons",color:"default"}),h.define("bt-selectpicker",function(b){a.fn.selectpicker&&a.fn.selectpicker.Constructor||i.error("MissingLibrary",'Bootstrap Select is required to use "bt-selectpicker" plugin. Get it here: http://silviomoreto.github.io/bootstrap-select');var c=h.selectors;this.on("afterCreateRuleFilters",function(a,d){d.$el.find(c.rule_filter).removeClass("form-control").selectpicker(b)}),this.on("afterCreateRuleOperators",function(a,d){d.$el.find(c.rule_operator).removeClass("form-control").selectpicker(b)}),this.on("afterUpdateRuleFilter",function(a,b){b.$el.find(c.rule_filter).selectpicker("render")}),this.on("afterUpdateRuleOperator",function(a,b){b.$el.find(c.rule_operator).selectpicker("render")}),this.on("beforeDeleteRule",function(a,b){b.$el.find(c.rule_filter).selectpicker("destroy"),b.$el.find(c.rule_operator).selectpicker("destroy")})},{container:"body",style:"btn-inverse btn-xs",width:"auto",showIcon:!1}),h.define("bt-tooltip-errors",function(b){a.fn.tooltip&&a.fn.tooltip.Constructor&&a.fn.tooltip.Constructor.prototype.fixTitle||i.error("MissingLibrary",'Bootstrap Tooltip is required to use "bt-tooltip-errors" plugin. Get it here: http://getbootstrap.com');var c=this;this.on("getRuleTemplate.filter getGroupTemplate.filter",function(b){var c=a(b.value);c.find(h.selectors.error_container).attr("data-toggle","tooltip"),b.value=c.prop("outerHTML")}),this.model.on("update",function(a,d,e){"error"==e&&c.settings.display_errors&&d.$el.find(h.selectors.error_container).eq(0).tooltip(b).tooltip("hide").tooltip("fixTitle")})},{placement:"right"}),h.extend({setFilters:function(a,b){var c=this;void 0===b&&(b=a,a=!1),b=this.checkFilters(b),b=this.change("setFilters",b);var d=b.map(function(a){return a.id});if(a||!function f(a){a.each(function(a){a.filter&&d.indexOf(a.filter.id)===-1&&i.error("ChangeFilter",'A rule is using filter "{0}"',a.filter.id)},f)}(this.model.root),this.filters=b,function g(a){a.each(!0,function(a){a.filter&&d.indexOf(a.filter.id)===-1?(a.drop(),c.trigger("rulesChanged")):(c.createRuleFilters(a),a.$el.find(h.selectors.rule_filter).val(a.filter?a.filter.id:"-1"),c.trigger("afterUpdateRuleFilter",a))},g)}(this.model.root),this.settings.plugins&&(this.settings.plugins["unique-filter"]&&this.updateDisabledFilters(),this.settings.plugins["bt-selectpicker"]&&this.$el.find(h.selectors.rule_filter).selectpicker("render")),this.settings.default_filter)try{this.getFilterById(this.settings.default_filter)}catch(e){this.settings.default_filter=null}this.trigger("afterSetFilters",b)},addFilter:function(b,c){void 0===c||"#end"==c?c=this.filters.length:"#start"==c&&(c=0),a.isArray(b)||(b=[b]);var d=a.extend(!0,[],this.filters);parseInt(c)==c?Array.prototype.splice.apply(d,[c,0].concat(b)):this.filters.some(function(a,b){if(a.id==c)return c=b+1,!0})?Array.prototype.splice.apply(d,[c,0].concat(b)):Array.prototype.push.apply(d,b),this.setFilters(d)},removeFilter:function(b,c){var d=a.extend(!0,[],this.filters);"string"==typeof b&&(b=[b]),d=d.filter(function(a){return b.indexOf(a.id)===-1}),this.setFilters(c,d)}}),h.define("chosen-selectpicker",function(b){a.fn.chosen||i.error("MissingLibrary",'chosen is required to use "chosen-selectpicker" plugin. Get it here: https://github.com/harvesthq/chosen'),this.settings.plugins["bt-selectpicker"]&&i.error("Conflict","bt-selectpicker is already selected as the dropdown plugin. Please remove chosen-selectpicker from the plugin list");var c=h.selectors;this.on("afterCreateRuleFilters",function(a,d){d.$el.find(c.rule_filter).removeClass("form-control").chosen(b)}),this.on("afterCreateRuleOperators",function(a,d){d.$el.find(c.rule_operator).removeClass("form-control").chosen(b)}),this.on("afterUpdateRuleFilter",function(a,b){b.$el.find(c.rule_filter).trigger("chosen:updated")}),this.on("afterUpdateRuleOperator",function(a,b){b.$el.find(c.rule_operator).trigger("chosen:updated")}),this.on("beforeDeleteRule",function(a,b){b.$el.find(c.rule_filter).chosen("destroy"),b.$el.find(c.rule_operator).chosen("destroy")})}),h.define("collapse-groups",function(b){var c=this,d=h.selectors;this.on("afterInit",function(){c.$el.on("click.queryBuilder","[data-collapse=group]",function(){a(this).closest(d.group_container);c.collapse(a(this),b),c.toggleCollapseValue(a(this))}),c.$el.on("change.queryBuilder",".group-name",function(){c.setGroupName(a(this))})}),this.on("afterSetRules",function(){a.each(c.$el.find(d.group_container),function(d,e){var f=c.getModel(a(e));f.collapsed&&c.collapse(a(e).find('[data-collapse="group"]:first'),b),f.name&&a(e).find(".group-name:first").val(f.name)})}),this.on("getGroupTemplate.filter",function(e,f){var g=a(e.value);g.find(d.group_header).append('<button type="button" class="btn btn-xs btn-default" data-collapse="group"><i class="'+b.iconUp+'"></i> '+c.translate("collapse")+"</button>"),e.value=g.prop("outerHTML")}),b.namedGroups&&this.on("getGroupTemplate.filter",function(b,c){var e=a(b.value);e.find(d.group_header).append('<input type="text" maxlength="32" class="group-name">'),b.value=e.prop("outerHTML")}),this.on("groupToJson.filter",function(a,b){a.value.collapsed=b.collapsed,a.value.name=b.name}),this.on("jsonToGroup.filter",function(a,b){a.value.collapsed=b.collapsed,a.value.name=b.name})},{iconUp:"glyphicon glyphicon-chevron-up",iconDown:"glyphicon glyphicon-chevron-down",namedGroups:!0}),i.defineModelProperties(k,["name","collapsed"]),h.extend({collapse:function(a,b){var c=h.selectors,d=a.find("i");a.closest(c.group_container).find(c.rules_list+":first").slideToggle("fast"),a.parent().parent().find(c.group_condition+":first").parent().parent().toggleClass("collapsed"),a.parent().parent().find(c.add_rule+":first").toggleClass("collapsed"),a.parent().parent().find(c.add_group+":first").toggleClass("collapsed"),d.toggleClass(b.iconUp).toggleClass(b.iconDown)},toggleCollapseValue:function(a){var b=this.getModel(a.closest(h.selectors.group_container));b.collapsed=!b.collapsed},setGroupName:function(a){var b=a.val(),c=h.selectors,d=this.getModel(a.closest(c.group_container));d.name=b}}),h.define("filter-description",function(b){"inline"===b.mode?this.on("afterUpdateRuleFilter afterUpdateRuleOperator",function(c,d){var e=d.$el.find("p.filter-description"),f=c.builder.getFilterDescription(d.filter,d);f?(0===e.length?(e=a('<p class="filter-description"></p>'),e.appendTo(d.$el)):e.css("display",""),e.html('<i class="'+b.icon+'"></i> '+f)):e.hide()}):"popover"===b.mode?(a.fn.popover&&a.fn.popover.Constructor&&a.fn.popover.Constructor.prototype.fixTitle||i.error("MissingLibrary",'Bootstrap Popover is required to use "filter-description" plugin. Get it here: http://getbootstrap.com'),this.on("afterUpdateRuleFilter afterUpdateRuleOperator",function(c,d){var e=d.$el.find("button.filter-description"),f=c.builder.getFilterDescription(d.filter,d);f?(0===e.length?(e=a('<button type="button" class="btn btn-xs btn-info filter-description" data-toggle="popover"><i class="'+b.icon+'"></i></button>'),e.prependTo(d.$el.find(h.selectors.rule_actions)),e.popover({placement:"left",container:"body",html:!0}),e.on("mouseout",function(){e.popover("hide")})):e.css("display",""),e.data("bs.popover").options.content=f,e.attr("aria-describedby")&&e.popover("show")):(e.hide(),e.data("bs.popover")&&e.popover("hide"))})):"bootbox"===b.mode&&("bootbox"in d||i.error("MissingLibrary",'Bootbox is required to use "filter-description" plugin. Get it here: http://bootboxjs.com'),this.on("afterUpdateRuleFilter afterUpdateRuleOperator",function(c,d){var e=d.$el.find("button.filter-description"),f=c.builder.getFilterDescription(d.filter,d);f?(0===e.length?(e=a('<button type="button" class="btn btn-xs btn-info filter-description" data-toggle="bootbox"><i class="'+b.icon+'"></i></button>'),e.prependTo(d.$el.find(h.selectors.rule_actions)),e.on("click",function(){bootbox.alert(e.data("description"))})):e.css("display",""),e.data("description",f)):e.hide()}))},{icon:"glyphicon glyphicon-info-sign",mode:"popover"}),h.extend({getFilterDescription:function(a,b){return a?"function"==typeof a.description?a.description.call(this,b):a.description:void 0}}),h.define("invert",function(b){var c=this,d=h.selectors;this.on("afterInit",function(){c.$el.on("click.queryBuilder","[data-invert=group]",function(){var e=a(this).closest(d.group_container);c.invert(c.getModel(e),b)}),b.display_rules_button&&b.invert_rules&&c.$el.on("click.queryBuilder","[data-invert=rule]",function(){var e=a(this).closest(d.rule_container);c.invert(c.getModel(e),b)})}),b.disable_template||(this.on("getGroupTemplate.filter",function(e){var f=a(e.value);f.find(d.condition_container).after('<button type="button" class="btn btn-xs btn-default" data-invert="group"><i class="'+b.icon+'"></i> '+c.translate("invert")+"</button>"),e.value=f.prop("outerHTML")}),b.display_rules_button&&b.invert_rules&&this.on("getRuleTemplate.filter",function(e){var f=a(e.value);f.find(d.rule_actions).prepend('<button type="button" class="btn btn-xs btn-default" data-invert="rule"><i class="'+b.icon+'"></i> '+c.translate("invert")+"</button>"),e.value=f.prop("outerHTML")}))},{icon:"glyphicon glyphicon-random",recursive:!0,invert_rules:!0,display_rules_button:!1,silent_fail:!1,disable_template:!1}),h.defaults({operatorOpposites:{equal:"not_equal",not_equal:"equal","in":"not_in",not_in:"in",less:"greater_or_equal",less_or_equal:"greater",greater:"less_or_equal",greater_or_equal:"less",between:"not_between",not_between:"between",begins_with:"not_begins_with",not_begins_with:"begins_with",contains:"not_contains",not_contains:"contains",ends_with:"not_ends_with",not_ends_with:"ends_with",is_empty:"is_not_empty",is_not_empty:"is_empty",is_null:"is_not_null",is_not_null:"is_null"},conditionOpposites:{AND:"OR",OR:"AND"}}),h.extend({invert:function(b,c){if(!(b instanceof j)){if(!this.model.root)return;c=b,b=this.model.root}if("object"!=typeof c&&(c={}),void 0===c.recursive&&(c.recursive=!0),void 0===c.invert_rules&&(c.invert_rules=!0),void 0===c.silent_fail&&(c.silent_fail=!1),void 0===c.trigger&&(c.trigger=!0),b instanceof k){if(this.settings.conditionOpposites[b.condition]?b.condition=this.settings.conditionOpposites[b.condition]:c.silent_fail||i.error("InvertCondition",'Unknown inverse of condition "{0}"',b.condition),c.recursive){var d=a.extend({},c,{trigger:!1});b.each(function(a){c.invert_rules&&this.invert(a,d)},function(a){this.invert(a,d)},this)}}else if(b instanceof l&&b.operator&&!b.filter.no_invert)if(this.settings.operatorOpposites[b.operator.type]){var e=this.settings.operatorOpposites[b.operator.type];b.filter.operators&&b.filter.operators.indexOf(e)==-1||(b.operator=this.getOperatorByType(e))}else c.silent_fail||i.error("InvertOperator",'Unknown inverse of operator "{0}"',b.operator.type);c.trigger&&(this.trigger("afterInvert",b,c),this.trigger("rulesChanged"))}}),h.defaults({mongoOperators:{equal:function(a){return a[0]},not_equal:function(a){return{$ne:a[0]}},"in":function(a){return{$in:a}},not_in:function(a){return{$nin:a}},less:function(a){return{$lt:a[0]}},less_or_equal:function(a){return{$lte:a[0]}},greater:function(a){return{$gt:a[0]}},greater_or_equal:function(a){return{$gte:a[0]}},between:function(a){return{$gte:a[0],$lte:a[1]}},not_between:function(a){return{$lt:a[0],$gt:a[1]}},begins_with:function(a){return{$regex:"^"+i.escapeRegExp(a[0])}},not_begins_with:function(a){return{$regex:"^(?!"+i.escapeRegExp(a[0])+")"}},contains:function(a){return{$regex:i.escapeRegExp(a[0])}},not_contains:function(a){return{$regex:"^((?!"+i.escapeRegExp(a[0])+").)*$",$options:"s"}},ends_with:function(a){return{$regex:i.escapeRegExp(a[0])+"$"}},not_ends_with:function(a){return{$regex:"(?<!"+i.escapeRegExp(a[0])+")$"}},is_empty:function(a){return""},is_not_empty:function(a){return{$ne:""}},is_null:function(a){return null},is_not_null:function(a){return{$ne:null}}},mongoRuleOperators:{$eq:function(a){return{val:a,op:null===a?"is_null":""===a?"is_empty":"equal"}},$ne:function(a){return a=a.$ne,{val:a,op:null===a?"is_not_null":""===a?"is_not_empty":"not_equal"}},$regex:function(a){return a=a.$regex,"^(?!"==a.slice(0,4)&&")"==a.slice(-1)?{val:a.slice(4,-1),op:"not_begins_with"}:"^((?!"==a.slice(0,5)&&").)*$"==a.slice(-5)?{val:a.slice(5,-5),op:"not_contains"}:"(?<!"==a.slice(0,4)&&")$"==a.slice(-2)?{val:a.slice(4,-2),op:"not_ends_with"}:"$"==a.slice(-1)?{val:a.slice(0,-1),op:"ends_with"}:"^"==a.slice(0,1)?{val:a.slice(1),op:"begins_with"}:{val:a,op:"contains"}},between:function(a){return{val:[a.$gte,a.$lte],op:"between"}},not_between:function(a){return{val:[a.$lt,a.$gt],op:"not_between"}},$in:function(a){return{val:a.$in,op:"in"}},$nin:function(a){return{val:a.$nin,op:"not_in"}},$lt:function(a){return{val:a.$lt,op:"less"}},$lte:function(a){return{val:a.$lte,op:"less_or_equal"}},$gt:function(a){return{val:a.$gt,op:"greater"}},$gte:function(a){return{val:a.$gte,op:"greater_or_equal"}}}}),h.extend({getMongo:function(a){if(a=void 0===a?this.getRules():a,!a)return null;var b=this;return function c(a){if(a.condition||(a.condition=b.settings.default_condition),["AND","OR"].indexOf(a.condition.toUpperCase())===-1&&i.error("UndefinedMongoCondition",'Unable to build MongoDB query with condition "{0}"',a.condition),!a.rules)return{};var d=[];a.rules.forEach(function(a){if(a.rules&&a.rules.length>0)d.push(c(a));else{var e=b.settings.mongoOperators[a.operator],f=b.getOperatorByType(a.operator);void 0===e&&i.error("UndefinedMongoOperator",'Unknown MongoDB operation for operator "{0}"',a.operator),0!==f.nb_inputs&&(a.value instanceof Array||(a.value=[a.value]));var g=b.change("getMongoDBField",a.field,a),h={};h[g]=e.call(b,a.value),d.push(b.change("ruleToMongo",h,a,a.value,e))}});var e={};return e["$"+a.condition.toLowerCase()]=d,b.change("groupToMongo",e,a)}(a)},getRulesFromMongo:function(a){if(void 0===a||null===a)return null;var b=this;if(a=b.change("parseMongoNode",a),"rules"in a&&"condition"in a)return a;if("id"in a&&"operator"in a&&"value"in a)return{condition:this.settings.default_condition,rules:[a]};var c=b.getMongoCondition(a);return c||i.error("MongoParse","Invalid MongoDB query format"),function d(a,c){var e=a[c],f=[];return e.forEach(function(a){if(a=b.change("parseMongoNode",a),"rules"in a&&"condition"in a)return void f.push(a);if("id"in a&&"operator"in a&&"value"in a)return void f.push(a);var c=b.getMongoCondition(a);if(c)f.push(d(a,c));else{var e=Object.keys(a)[0],g=a[e],h=b.getMongoOperator(g);void 0===h&&i.error("MongoParse","Invalid MongoDB query format");var j=b.settings.mongoRuleOperators[h];void 0===j&&i.error("UndefinedMongoOperator",'JSON Rule operation unknown for operator "{0}"',h);var k=j.call(b,g),l=b.getMongoDBFieldID(e,g),m=b.change("mongoToRule",{id:l,field:e,operator:k.op,value:k.val},a);f.push(m)}}),b.change("mongoToGroup",{condition:c.replace("$","").toUpperCase(),rules:f},a)}(a,c)},setRulesFromMongo:function(a){this.setRules(this.getRulesFromMongo(a))},getMongoDBFieldID:function(a,b){var c,d=this.filters.filter(function(b){return b.field===a});return c=1===d.length?d[0].id:this.change("getMongoDBFieldID",a,b)},getMongoOperator:function(a){if(null===a||"object"!=typeof a)return"$eq";if(void 0!==a.$gte&&void 0!==a.$lte)return"between";if(void 0!==a.$lt&&void 0!==a.$gt)return"not_between";var b=Object.keys(a).filter(function(a){return!!this.settings.mongoRuleOperators[a]}.bind(this));return 1===b.length?b[0]:void 0},getMongoCondition:function(a){for(var b=Object.keys(a),c=0,d=b.length;c<d;c++)if("$or"===b[c].toLowerCase()||"$and"===b[c].toLowerCase())return b[c]}}),h.define("not-group",function(b){var c=this;if(this.on("afterInit",function(){c.$el.on("click.queryBuilder","[data-not=group]",function(){var b=a(this).closest(h.selectors.group_container),d=c.getModel(b);d.not=!d.not}),c.model.on("update",function(a,b,d){b instanceof k&&"not"===d&&c.updateGroupNot(b)})}),this.on("afterAddGroup",function(a,b){b.__.not=!1}),b.disable_template||this.on("getGroupTemplate.filter",function(d){var e=a(d.value);e.find(h.selectors.condition_container).prepend('<button type="button" class="btn btn-xs btn-default" data-not="group"><i class="'+b.icon_unchecked+'"></i> '+c.translate("NOT")+"</button>"),d.value=e.prop("outerHTML")}),this.on("groupToJson.filter",function(a,b){a.value.not=b.not}),this.on("jsonToGroup.filter",function(a,b){a.value.not=!!b.not}),this.on("groupToSQL.filter",function(a,b){b.not&&(a.value="NOT ( "+a.value+" )")}),"SQLParser"in d){var e=d.SQLParser;this.on("parseSQLNode.filter",function(a){a.value.name&&"NOT"==a.value.name.toUpperCase()&&(a.value=a.value.arguments.value[0],["AND","OR"].indexOf(a.value.operation.toUpperCase())===-1&&(a.value=new e.nodes.Op(c.settings.default_condition,a.value,null)),a.value.not=!0)})}this.on("sqlGroupsDistinct.filter",function(a,b,c,d){c.not&&d>0&&(a.value=!0)}),this.on("sqlToGroup.filter",function(a,b){a.value.not=!!b.not}),this.on("groupToMongo.filter",function(a,b){var c="$"+b.condition.toLowerCase();b.not&&a.value[c]&&(a.value={$nor:[a.value]})}),this.on("parseMongoNode.filter",function(a){var b=Object.keys(a.value);"$nor"==b[0]&&(a.value=a.value[b[0]][0],a.value.not=!0)}),this.on("mongoToGroup.filter",function(a,b){a.value.not=!!b.not})},{icon_unchecked:"glyphicon glyphicon-unchecked",icon_checked:"glyphicon glyphicon-check",disable_template:!1}),i.defineModelProperties(k,["not"]),h.selectors.group_not=h.selectors.group_header+" [data-not=group]",h.extend({updateGroupNot:function(a){var b=this.plugins["not-group"];a.$el.find(">"+h.selectors.group_not).toggleClass("active",a.not).find("i").attr("class",a.not?b.icon_checked:b.icon_unchecked),this.trigger("afterUpdateGroupNot",a),this.trigger("rulesChanged")}}),h.define("sortable",function(b){"interact"in d||i.error("MissingLibrary",'interact.js is required to use "sortable" plugin. Get it here: http://interactjs.io'),void 0!==b.default_no_sortable&&(i.error(!1,"Config",'Sortable plugin : "default_no_sortable" options is deprecated, use standard "default_rule_flags" and "default_group_flags" instead'),this.settings.default_rule_flags.no_sortable=this.settings.default_group_flags.no_sortable=b.default_no_sortable),interact.dynamicDrop(!0),interact.pointerMoveTolerance(10);var c,e,g,j,l=b.autoScrollContainer||this.$el[0],m=(l!==this.$el[0],b.autoScrollContainerSelector);this.on("afterAddRule afterAddGroup",function(d,i){if(i!=c){var n=d.builder;b.inherit_no_sortable&&i.parent&&i.parent.flags.no_sortable&&(i.flags.no_sortable=!0),b.inherit_no_drop&&i.parent&&i.parent.flags.no_drop&&(i.flags.no_drop=!0),i.flags.no_sortable||interact(i.$el[0]).draggable({allowFrom:h.selectors.drag_handle,autoScroll:{container:l},onstart:function(b){j=!1,g=n.getModel(b.target),e=g.$el.clone().appendTo(g.$el.parent()).width(g.$el.outerWidth()).addClass("dragging").css("position","fixed");var d=b.target.getBoundingClientRect(),f=d.x,h=d.y;h+=m?a(m).scrollTop():l.scrollTop,f+=m?a(m).scrollLeft():l.scrollLeft,e[0].style.top=h+"px",e[0].style.left=f+"px";var i=a('<div class="rule-placeholder">&nbsp;</div>').height(g.$el.outerHeight());c=g.parent.addRule(i,g.getPos()),g.$el.hide()},onmove:function(a){if(e&&e[0]){var b=e[0].style.top,c=e[0].style.left;b=b.substr(0,b.length-2),c=c.substr(0,c.length-2),c=+c+ +a.dx,b=+b+ +a.dy,e[0].style.top=b+"px",e[0].style.left=c+"px"}},onend:function(b){b.dropzone&&(f(g,a(b.relatedTarget),n),j=!0),e&&e.remove(),e=void 0,c.drop(),c=void 0,g.$el.css("display",""),n.trigger("afterMove",g),n.trigger("rulesChanged")}}),i.flags.no_drop||(interact(i.$el[0]).dropzone({accept:h.selectors.rule_and_group_containers,ondragenter:function(b){f(c,a(b.target),n)},ondrop:function(b){j||f(g,a(b.target),n)}}),i instanceof k&&interact(i.$el.find(h.selectors.group_header)[0]).dropzone({accept:h.selectors.rule_and_group_containers,ondragenter:function(b){f(c,a(b.target),n)},ondrop:function(b){j||f(g,a(b.target),n)}}))}}),this.on("beforeDeleteRule beforeDeleteGroup",function(a,b){a.isDefaultPrevented()||(interact(b.$el[0]).unset(),b instanceof k&&interact(b.$el.find(h.selectors.group_header)[0]).unset())}),this.on("afterApplyRuleFlags afterApplyGroupFlags",function(a,b){b.flags.no_sortable&&b.$el.find(h.selectors.drag_handle).remove()}),b.disable_template||(this.on("getGroupTemplate.filter",function(c,d){if(d>1){var e=a(c.value);e.find(h.selectors.condition_container).after('<div class="drag-handle"><i class="'+b.icon+'"></i></div>'),c.value=e.prop("outerHTML")}}),this.on("getRuleTemplate.filter",function(c){var d=a(c.value);d.find(h.selectors.rule_header).after('<div class="drag-handle"><i class="'+b.icon+'"></i></div>'),
c.value=d.prop("outerHTML")}))},{inherit_no_sortable:!0,inherit_no_drop:!0,icon:"glyphicon glyphicon-sort",disable_template:!1}),h.selectors.rule_and_group_containers=h.selectors.rule_container+", "+h.selectors.group_container,h.selectors.drag_handle=".drag-handle",h.defaults({default_rule_flags:{no_sortable:!1,no_drop:!1},default_group_flags:{no_sortable:!1,no_drop:!1}}),h.define("sql-support",function(a){},{boolean_as_integer:!0}),h.defaults({sqlOperators:{equal:{op:"= ?"},not_equal:{op:"!= ?"},"in":{op:"IN(?)",sep:", "},not_in:{op:"NOT IN(?)",sep:", "},less:{op:"< ?"},less_or_equal:{op:"<= ?"},greater:{op:"> ?"},greater_or_equal:{op:">= ?"},between:{op:"BETWEEN ?",sep:" AND "},not_between:{op:"NOT BETWEEN ?",sep:" AND "},begins_with:{op:"LIKE(?)",mod:"{0}%"},not_begins_with:{op:"NOT LIKE(?)",mod:"{0}%"},contains:{op:"LIKE(?)",mod:"%{0}%"},not_contains:{op:"NOT LIKE(?)",mod:"%{0}%"},ends_with:{op:"LIKE(?)",mod:"%{0}"},not_ends_with:{op:"NOT LIKE(?)",mod:"%{0}"},is_empty:{op:"= ''"},is_not_empty:{op:"!= ''"},is_null:{op:"IS NULL"},is_not_null:{op:"IS NOT NULL"}},sqlRuleOperator:{"=":function(a){return{val:a,op:""===a?"is_empty":"equal"}},"!=":function(a){return{val:a,op:""===a?"is_not_empty":"not_equal"}},LIKE:function(a){return"%"==a.slice(0,1)&&"%"==a.slice(-1)?{val:a.slice(1,-1),op:"contains"}:"%"==a.slice(0,1)?{val:a.slice(1),op:"ends_with"}:"%"==a.slice(-1)?{val:a.slice(0,-1),op:"begins_with"}:void i.error("SQLParse",'Invalid value for LIKE operator "{0}"',a)},"NOT LIKE":function(a){return"%"==a.slice(0,1)&&"%"==a.slice(-1)?{val:a.slice(1,-1),op:"not_contains"}:"%"==a.slice(0,1)?{val:a.slice(1),op:"not_ends_with"}:"%"==a.slice(-1)?{val:a.slice(0,-1),op:"not_begins_with"}:void i.error("SQLParse",'Invalid value for NOT LIKE operator "{0}"',a)},IN:function(a){return{val:a,op:"in"}},"NOT IN":function(a){return{val:a,op:"not_in"}},"<":function(a){return{val:a,op:"less"}},"<=":function(a){return{val:a,op:"less_or_equal"}},">":function(a){return{val:a,op:"greater"}},">=":function(a){return{val:a,op:"greater_or_equal"}},BETWEEN:function(a){return{val:a,op:"between"}},"NOT BETWEEN":function(a){return{val:a,op:"not_between"}},IS:function(a){return null!==a&&i.error("SQLParse","Invalid value for IS operator"),{val:null,op:"is_null"}},"IS NOT":function(a){return null!==a&&i.error("SQLParse","Invalid value for IS operator"),{val:null,op:"is_not_null"}}},sqlStatements:{question_mark:function(){var a=[];return{add:function(b,c){return a.push(c),"?"},run:function(){return a}}},numbered:function(a){(!a||a.length>1)&&(a="$");var b=0,c=[];return{add:function(d,e){return c.push(e),b++,a+b},run:function(){return c}}},named:function(a){(!a||a.length>1)&&(a=":");var b={},c={};return{add:function(d,e){b[d.field]||(b[d.field]=1);var f=d.field+"_"+b[d.field]++;return c[f]=e,a+f},run:function(){return c}}}},sqlRuleStatement:{question_mark:function(a){var b=0;return{parse:function(c){return"?"==c?a[b++]:c},esc:function(a){return a.replace(/\?/g,"'?'")}}},numbered:function(a,b){(!b||b.length>1)&&(b="$");var c=new RegExp("^\\"+b+"[0-9]+$"),d=new RegExp("\\"+b+"([0-9]+)","g");return{parse:function(b){return c.test(b)?a[b.slice(1)-1]:b},esc:function(a){return a.replace(d,"'"+("$"==b?"$$":b)+"$1'")}}},named:function(a,b){(!b||b.length>1)&&(b=":");var c=new RegExp("^\\"+b),d=new RegExp("\\"+b+"("+Object.keys(a).join("|")+")","g");return{parse:function(b){return c.test(b)?a[b.slice(1)]:b},esc:function(a){return a.replace(d,"'"+("$"==b?"$$":b)+"$1'")}}}}}),h.extend({getSQL:function(a,b,c){if(c=void 0===c?this.getRules():c,!c)return null;b=b?"\n":" ";this.getPluginOptions("sql-support","boolean_as_integer");if(a===!0&&(a="question_mark"),"string"==typeof a){var d=g(a);a=this.settings.sqlStatements[d[1]](d[2])}var e=this,f=function h(c){if(c.condition||(c.condition=e.settings.default_condition),["AND","OR"].indexOf(c.condition.toUpperCase())===-1&&i.error("UndefinedSQLCondition",'Unable to build SQL query with condition "{0}"',c.condition),!c.rules)return"";var d=[];c.rules.forEach(function(c){if(c.rules&&c.rules.length>0)d.push("("+b+h(c)+b+")"+b);else{var f=e.settings.sqlOperators[c.operator],g=e.getOperatorByType(c.operator),j="";void 0===f&&i.error("UndefinedSQLOperator",'Unknown SQL operation for operator "{0}"',c.operator);var k;"function"==typeof f.sqlFn?k=function(a){return f.sqlFn(c.value)}:(0!==g.nb_inputs&&(c.value instanceof Array||(c.value=[c.value]),c.value.forEach(function(b,d){d>0&&(j+=f.sep),"integer"==c.type||"double"==c.type||"boolean"==c.type?b=i.changeType(b,c.type,!0):a||"datetime"==c.type||(b=i.escapeString(b)),f.mod&&(b=i.fmt(f.mod,b)),a?j+=a.add(c,b):(f.ic||c.data.ignore_case===!0?f.sep?"string"==typeof b?b=b.split(",").map(function(a){return"'"+a.trim().toLowerCase()+"'"}):Array.isArray(b)&&(b=b.map(function(a){return a.toString().trim().toLowerCase()})):"string"==typeof b&&(b=b.toLowerCase(),b="'"+b+"'"):f.sep?"datetime"!=c.type?"string"==typeof b?b=b.split(",").map(function(a){return"'"+a.trim()+"'"}):Array.isArray(b)&&(b=b.map(function(a){return a.toString().trim()})):b.indexOf("SYSDATE")>-1?"string"==typeof b?b="("+b.trim()+")":Array.isArray(b)&&(b=b.map(function(a){return a.toString().trim()})):"string"==typeof b?b=b.split(",").map(function(a){return"TO_TIMESTAMP('"+a+"', 'YYYY-MM-DD HH24:MI:SS')"}):Array.isArray(b)&&(b=b.map(function(a){return"TO_TIMESTAMP('"+a.toString().trim()+"', 'YYYY-MM-DD HH24:MI:SS')"})):"datetime"==c.type?b.indexOf("SYSDATE")>-1?"string"==typeof b&&(b="("+b.trim()+")"):"string"==typeof b&&(b="TO_TIMESTAMP('"+b+"', 'YYYY-MM-DD HH24:MI:SS')"):"string"==typeof b&&(b="'"+b+"'"),j+=b)})),k=function(a){return f.op.replace("?",function(){return a})});var l=e.change("getSQLField",c.field,c);(f.ic||c.data.ignore_case===!0)&&(l="LOWER("+l+")");var m;m="function"==typeof f.sqlFullFn?f.sqlFullFn(l,j,c.value):l+" "+k(j),d.push(e.change("ruleToSQL",m,c,j,k))}});var f=d.join(" "+c.condition+b);return e.change("groupToSQL",f,c)}(c);return a?{sql:f,params:a.run()}:{sql:f}},getRulesFromSQL:function(b,c){"SQLParser"in d||i.error("MissingLibrary","SQLParser is required to parse SQL queries. Get it here https://github.com/mistic100/sql-parser");var e=d.SQLParser,f=this;if("string"==typeof b&&(b={sql:b}),c===!0&&(c="question_mark"),"string"==typeof c){var h=g(c);c=this.settings.sqlRuleStatement[h[1]](b.params,h[2])}c&&(b.sql=c.esc(b.sql)),0!==b.sql.toUpperCase().indexOf("SELECT")&&(b.sql="SELECT * FROM table WHERE "+b.sql);var j=e.parse(b.sql);j.where||i.error("SQLParse","No WHERE clause found");var k=f.change("parseSQLNode",j.where.conditions);if("rules"in k&&"condition"in k)return k;if("id"in k&&"operator"in k&&"value"in k)return{condition:this.settings.default_condition,rules:[k]};var l=f.change("sqlToGroup",{condition:this.settings.default_condition,rules:[]},k),m=l;return function n(b,d){if(null!==b){if(b=f.change("parseSQLNode",b),"rules"in b&&"condition"in b)return void m.rules.push(b);if("id"in b&&"operator"in b&&"value"in b)return void m.rules.push(b);if("left"in b&&"right"in b&&"operation"in b||i.error("SQLParse","Unable to parse WHERE clause"),["AND","OR"].indexOf(b.operation.toUpperCase())!==-1){var e=f.change("sqlGroupsDistinct",d>0&&m.condition!=b.operation.toUpperCase(),m,b,d);if(e){var g=f.change("sqlToGroup",{condition:f.settings.default_condition,rules:[]},b);m.rules.push(g),m=g}m.condition=b.operation.toUpperCase(),d++;var h=m;n(b.left,d),m=h,n(b.right,d)}else{a.isPlainObject(b.right.value)&&i.error("SQLParse","Value format not supported for {0}.",b.left.value);var j;j=a.isArray(b.right.value)?b.right.value.map(function(a){return a.value}):b.right.value,c&&(j=a.isArray(j)?j.map(c.parse):c.parse(j));var k=b.operation.toUpperCase();"<>"==k&&(k="!=");var l=f.settings.sqlRuleOperator[k];void 0===l&&i.error("UndefinedSQLOperator",'Invalid SQL operation "{0}".',b.operation);var o,p=l.call(this,j,b.operation);"values"in b.left?o=b.left.values.join("."):"value"in b.left?o=b.left.value:i.error("SQLParse","Cannot find field name in {0}",JSON.stringify(b.left));var q=f.getSQLFieldID(o,j),r=f.change("sqlToRule",{id:q,field:o,operator:p.op,value:p.val},b);m.rules.push(r)}}}(k,0),l},setRulesFromSQL:function(a,b){this.setRules(this.getRulesFromSQL(a,b))},getSQLFieldID:function(a,b){var c,d=this.filters.filter(function(b){return b.field.toLowerCase()===a.toLowerCase()});return c=1===d.length?d[0].id:this.change("getSQLFieldID",a,b)}}),h.define("unique-filter",function(){this.status.used_filters={},this.on("afterUpdateRuleFilter",this.updateDisabledFilters),this.on("afterDeleteRule",this.updateDisabledFilters),this.on("afterCreateRuleFilters",this.applyDisabledFilters),this.on("afterReset",this.clearDisabledFilters),this.on("afterClear",this.clearDisabledFilters),this.on("getDefaultFilter.filter",function(a,b){var c=a.builder;if(c.updateDisabledFilters(),a.value.id in c.status.used_filters){var d=c.filters.some(function(d){if(!(d.id in c.status.used_filters)||c.status.used_filters[d.id].length>0&&c.status.used_filters[d.id].indexOf(b.parent)===-1)return a.value=d,!0});d||(i.error(!1,"UniqueFilter","No more non-unique filters available"),a.value=void 0)}})}),h.extend({updateDisabledFilters:function(a){var b=a?a.builder:this;b.status.used_filters={},b.model&&(!function c(a){a.each(function(a){a.filter&&a.filter.unique&&(b.status.used_filters[a.filter.id]||(b.status.used_filters[a.filter.id]=[]),"group"==a.filter.unique&&b.status.used_filters[a.filter.id].push(a.parent))},function(a){c(a)})}(b.model.root),b.applyDisabledFilters(a))},clearDisabledFilters:function(a){var b=a?a.builder:this;b.status.used_filters={},b.applyDisabledFilters(a)},applyDisabledFilters:function(b){var c=b?b.builder:this;c.$el.find(h.selectors.filter_container+" option").prop("disabled",!1),a.each(c.status.used_filters,function(a,b){0===b.length?c.$el.find(h.selectors.filter_container+' option[value="'+a+'"]:not(:selected)').prop("disabled",!0):b.forEach(function(b){b.each(function(b){b.$el.find(h.selectors.filter_container+' option[value="'+a+'"]:not(:selected)').prop("disabled",!0)})})}),c.settings.plugins&&c.settings.plugins["bt-selectpicker"]&&c.$el.find(h.selectors.rule_filter).selectpicker("render")}}),h.regional.en={__locale:"English (en)",__author:'Damien "Mistic" Sorel, http://www.strangeplanet.fr',add_rule:"Add rule",add_group:"Add group",delete_rule:"Delete",delete_group:"Delete",add_rule_title:"Add rule",add_group_title:"Add group",delete_rule_title:"Delete rule",delete_group_title:"Delete group",conditions:{AND:"AND",OR:"OR"},operators:{equal:"equal",not_equal:"not equal","in":"in",not_in:"not in",less:"less",less_or_equal:"less or equal",greater:"greater",greater_or_equal:"greater or equal",between:"between",not_between:"not between",begins_with:"begins with",not_begins_with:"doesn't begin with",contains:"contains",not_contains:"doesn't contain",ends_with:"ends with",not_ends_with:"doesn't end with",is_empty:"is empty",is_not_empty:"is not empty",is_null:"is null",is_not_null:"is not null"},errors:{no_filter:"No filter selected",empty_group:"The group is empty",radio_empty:"No value selected",checkbox_empty:"No value selected",select_empty:"No value selected",string_empty:"Empty value",string_exceed_min_length:"Must contain at least {0} characters",string_exceed_max_length:"Must not contain more than {0} characters",string_invalid_format:"Invalid format ({0})",number_nan:"Not a number",number_not_integer:"Not an integer",number_not_double:"Not a real number",number_exceed_min:"Must be greater than {0}",number_exceed_max:"Must be lower than {0}",number_wrong_step:"Must be a multiple of {0}",number_between_invalid:"Invalid values, {0} is greater than {1}",datetime_empty:"Empty value",datetime_invalid:"Invalid date format ({0})",datetime_exceed_min:"Must be after {0}",datetime_exceed_max:"Must be before {0}",datetime_between_invalid:"Invalid values, {0} is greater than {1}",boolean_not_valid:"Not a boolean",operator_not_multiple:'Operator "{1}" cannot accept multiple values'},invert:"Invert",NOT:"NOT"},h.defaults({lang_code:"en"}),h});